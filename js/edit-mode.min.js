window.EditMode=(function(h){var g={el:h("#edit-mode"),list:Task.view.getListEl(),btnEnable:h("#btn-edit-tasks"),btnDisable:h("#btn-edit-mode-close"),btnDelete:h("#btn-delete-tasks"),btnMove:h("#btn-move-tasks"),btnIndent:h("#btn-unindent-tasks"),btnUnindent:h("#btn-indent-tasks")},i="selected",m=false,k=false;function p(){g.btnEnable.on("click",EditMode.enable);g.btnDisable.on("click",EditMode.disable);g.list.on("change",'.pack-checkbox.danger input[type="checkbox"]',o);g.btnDelete.on("click",n);g.btnMove.on("click",b);g.btnIndent.on("click",f);g.btnUnindent.on("click",f)}function o(){var q=Task.view.getCheckedItems();e(h(this).parents("a").first());c(q.length)}function e(q){if(!q.hasClass(i)){q.addClass(i)}else{q.removeClass(i)}}function n(){var s=Task.view.getCheckedItems(),r=List.getLastActive().id;if(s.length===0){j();return}var t={h1:"Delete Tasks",p:s.length+" selected tasks will be deleted. Continue?",cancel:"Cancel",ok:"Delete",action:function(){EditMode.disable();q(s)}};App.confirm(t);function q(u){var w=u.shift();var v={listId:r,taskId:w};Task.deleteTask(v,function(){if(u.length>0){q(u)}else{App.startSyncQueue()}})}}function b(){var x=h("#tasks-move-to"),r=Task.view.getCheckedItems(),u=[],q=List.getLastActive().id;if(r.length===0){j();return}w(t);function v(y){if(y){x.removeClass().addClass("fade-in")}else{x.removeClass().addClass("fade-out")}}function s(y,A){var z=y.shift();Task.storage.get(q,z,function(B){for(var C=0;C<y.length;C++){if(B.childrenIds.indexOf(y[C])>-1){y.splice(C,1);C--}}u.push(z);if(y.length>0){s(y,A)}else{A&&A()}})}function w(z){var y=x.find("menu").first();y.html("");List.storage.get(null,function(A){A.forEach(function(B){if(B.id!==q){y.append('<button data-id="'+B.id+'" class="prevent-default">'+B.title+"</button>")}});y.append('<button class="prevent-default">Cancel</button>');v(true);z()})}function t(){x.find("button[data-id]").off().on("click",function(){var z=this.dataset.id;EditMode.disable();s(r,function(){y(u.reverse())});function y(A){var B={listId:z,taskId:A.shift(),forceUpdate:true,openList:A.length===0,startImmediately:A.length===0};Task.updateTask(B,function(){if(A.length>0){y(A)}})}});x.on("click","button",function(){v(false)})}}function f(){var v=this.dataset.action.toLowerCase(),t=Task.view.getCheckedItems(),r=List.getLastActive().id;if(t.length===0){j();return}EditMode.preventDisabling(true);q(t);function q(w){var y=w.shift(),x=Task.view[v+"Item"](y,true);if(v==="unindent"&&x&&x.nextNodesIds.length>0){x.nextNodesIds.reverse();s(x.nextNodesIds,x.id)}else{u(x)}}function s(w,y){var x=w.shift();Task.moveTask(r,x,y,null,false,function(){if(w.length>0){s(w)}else{u()}})}function u(x){if(!x){w();return}Task.moveTask(r,x.id,x.parentId,x.previousId,false,function(){w()});function w(){if(t.length>0){q(t)}else{App.startSyncQueue();EditMode.preventDisabling(false)}}}}function d(){g.el.removeClass().addClass("edit");l(true)}function a(){g.el.removeClass("edit");l(false)}function l(q){if(q){g.list.append('<li class="dummy"></li>');g.list.find(".danger").show();g.list.find(".pack-checkbox:not(.danger)").hide();g.list.addClass("edit-mode")}else{g.list.find(".danger").hide().find('input[type="checkbox"]').prop("checked",false);g.list.find(".dummy").remove();g.list.find(".pack-checkbox:not(.danger)").show();g.list.find("."+i).removeClass(i);Task.view.getCheckedItems();g.list.removeClass("edit-mode")}}function c(q){g.el.find(".selected_num").html(q.toString())}function j(){utils.status.show("No tasks were selected",1000)}return{init:function(){p()},enable:function(){k=true;App.stopAutoFetch();Task.preventNextDelayedFetch();List.preventOnLoadRefresh();c(0);d()},disable:function(){if(m||!k){return}k=false;App.setAutoFetch();a()},preventDisabling:function(q){m=q}}}(jQuery));