window.EditMode=(function(i){var h={el:i("#edit-mode"),list:Task.view.getListEl(),btnDisable:i("#btn-edit-mode-close"),btnDelete:i("#btn-delete-tasks"),btnMove:i("#btn-move-tasks"),btnIndent:i("#btn-unindent-tasks"),btnUnindent:i("#btn-indent-tasks")},j="selected",n=false,l=false;function q(){h.btnDisable.on("click",EditMode.disable);h.list.on("change",'.pack-checkbox.danger input[type="checkbox"]',p);h.btnDelete.on("click",o);h.btnMove.on("click",b);h.btnIndent.on("click",g);h.btnUnindent.on("click",g)}function p(s,t){s=s.currentTarget||s;var r=EditMode.getCheckedItems();if(r.length===0){EditMode.disable();return}f(i(s).parents("a").first(),t);c(r.length)}function f(r,s){if(typeof s==="undefined"){r[0].classList.toggle(j)}else{if(s===true){r[0].classList.add(j)}else{r[0].classList.remove(j)}}}function o(){var t=EditMode.getCheckedItems(),s=List.getLastActive().id;if(t.length===0){k();return}var u={h1:"Delete Tasks",p:t.length+" selected tasks will be deleted. Continue?",cancel:"Cancel",ok:"Delete",action:function(){EditMode.disable();r(t)}};FT.confirm(u);function r(v){var x=v.shift();var w={listId:s,taskId:x};Task.deleteTask(w,function(){if(v.length>0){r(v)}else{FT.startSyncQueue()}})}}function b(){var y=i("#tasks-move-to"),s=EditMode.getCheckedItems(),v=[],r=List.getLastActive().id;if(!FT.isOnline()){utils.status.show("You are offline.\nUnfortunately, Fire Tasks is unable to move tasks in offline mode at the moment :(",4000);return}if(s.length===0){k();return}x(u);function w(z){if(z){y.removeClass().addClass("fade-in")}else{y.removeClass().addClass("fade-out")}}function t(z,B){var A=z.shift();Task.storage.get(r,A,function(C){for(var D=0;D<z.length;D++){if(C.childrenIds.indexOf(z[D])>-1){z.splice(D,1);D--}}v.push(A);if(z.length>0){t(z,B)}else{B&&B()}})}function x(A){var z=y.find("menu").first();z.html("");List.storage.get(null,function(B){B.forEach(function(C){if(C.id!==r){z.append('<button data-id="'+C.id+'" class="prevent-default">'+C.title+"</button>")}});z.append('<button class="prevent-default">Cancel</button>');w(true);A()})}function u(){y.find("button[data-id]").off().on("click",function(){var A=this.dataset.id;List.getById(A,function(B){if(B){EditMode.disable();t(s,function(){z(v.reverse())})}else{FT.confirm({h1:"Target list not found",p:"Target list seems deleted. We need to resynchronize data to keep data consistent.",ok:"Resynchronize",recommend:true,hideCancel:true,action:function(){EditMode.disable();FT.loadAll()}})}});function z(B){var C={listId:A,taskId:B.shift(),forceUpdate:true,openList:B.length===0,startImmediately:B.length===0};Task.updateTask(C,function(){if(B.length>0){z(B)}})}});y.on("click","button",function(){w(false)})}}function g(){var w=this.dataset.action.toLowerCase(),u=EditMode.getCheckedItems(),s=List.getLastActive().id;if(u.length===0){k();return}d(true);EditMode.preventDisabling(true);r(u);function r(x){var z=x.shift(),y=Task.view[w+"Item"](z,true);if(w==="unindent"&&y&&y.nextNodesIds.length>0){y.nextNodesIds.reverse();t(y.nextNodesIds,y.id)}else{v(y)}}function t(x,z){var y=x.shift();Task.moveTask(s,y,z,null,false,function(){if(x.length>0){t(x)}else{v()}})}function v(y){if(!y){x();return}Task.moveTask(s,y.id,y.parentId,y.previousId,false,function(){x()});function x(){if(u.length>0){r(u)}else{EditMode.preventDisabling(false);d(false);FT.startSyncQueue()}}}}function e(){h.el.removeClass().addClass("edit");m(true)}function a(){h.el.removeClass("edit");m(false)}function m(r){if(r){h.list.find(".danger").show();h.list.find(".pack-checkbox:not(.danger)").hide();h.list.addClass("edit-mode")}else{h.list.find(".danger").hide().find('input[type="checkbox"]').prop("checked",false);h.list.find(".pack-checkbox:not(.danger)").show();h.list.find("."+j).removeClass(j);h.list.removeClass("edit-mode")}}function c(r){h.el.find(".selected_num").html(r.toString())}function k(){utils.status.show("No tasks were selected",1000)}function d(r){if(r){h.btnIndent[0].disabled=true;h.btnUnindent[0].disabled=true;h.btnMove[0].disabled=true;h.btnDelete[0].disabled=true}else{h.btnIndent[0].disabled=false;h.btnUnindent[0].disabled=false;h.btnMove[0].disabled=false;h.btnDelete[0].disabled=false}}return{init:function(){q()},enable:function(r){if(typeof r==="undefined"){r=true}l=true;FT.stopAutoFetch();FT.preventStartupSync();EditMode.preventDisabling(false);d(false);r&&c(0);e()},disable:function(){if(n||!l){return}l=false;FT.setAutoFetch();a()},isEnabled:function(){return l},preventDisabling:function(r){n=r},getCheckedItems:function(){var r=[];h.list.find('.pack-checkbox.danger input[type="checkbox"]:checked').each(function(s,t){r.push(i(t).parents("a").first().attr("data-id"))});return r},setNodeChecked:function(r,u){var t=h.list[0].querySelector('a[data-id="'+r+'"]'),s=t&&t.querySelector('.pack-checkbox.danger input[type="checkbox"]');if(!s){return}s.checked=Boolean(u);p(s)}}}(jQuery));