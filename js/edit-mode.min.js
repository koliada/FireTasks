window.EditMode=(function(i){var h={el:i("#edit-mode"),list:Task.view.getListEl(),btnEnable:i("#btn-edit-tasks"),btnDisable:i("#btn-edit-mode-close"),btnDelete:i("#btn-delete-tasks"),btnMove:i("#btn-move-tasks"),btnIndent:i("#btn-unindent-tasks"),btnUnindent:i("#btn-indent-tasks")},j="selected",n=false,l=false;function q(){h.btnEnable.on("click",EditMode.enable);h.btnDisable.on("click",EditMode.disable);h.list.on("change",'.pack-checkbox.danger input[type="checkbox"]',p);h.btnDelete.on("click",o);h.btnMove.on("click",b);h.btnIndent.on("click",g);h.btnUnindent.on("click",g)}function p(){var r=Task.view.getCheckedItems();f(i(this).parents("a").first());c(r.length)}function f(r){if(!r.hasClass(j)){r.addClass(j)}else{r.removeClass(j)}}function o(){var t=Task.view.getCheckedItems(),s=List.getLastActive().id;if(t.length===0){k();return}var u={h1:"Delete Tasks",p:t.length+" selected tasks will be deleted. Continue?",cancel:"Cancel",ok:"Delete",action:function(){EditMode.disable();r(t)}};App.confirm(u);function r(v){var x=v.shift();var w={listId:s,taskId:x};Task.deleteTask(w,function(){if(v.length>0){r(v)}else{App.startSyncQueue()}})}}function b(){var y=i("#tasks-move-to"),s=Task.view.getCheckedItems(),v=[],r=List.getLastActive().id;if(s.length===0){k();return}x(u);function w(z){if(z){y.removeClass().addClass("fade-in")}else{y.removeClass().addClass("fade-out")}}function t(z,B){var A=z.shift();Task.storage.get(r,A,function(C){for(var D=0;D<z.length;D++){if(C.childrenIds.indexOf(z[D])>-1){z.splice(D,1);D--}}v.push(A);if(z.length>0){t(z,B)}else{B&&B()}})}function x(A){var z=y.find("menu").first();z.html("");List.storage.get(null,function(B){B.forEach(function(C){if(C.id!==r){z.append('<button data-id="'+C.id+'" class="prevent-default">'+C.title+"</button>")}});z.append('<button class="prevent-default">Cancel</button>');w(true);A()})}function u(){y.find("button[data-id]").off().on("click",function(){var A=this.dataset.id;EditMode.disable();t(s,function(){z(v.reverse())});function z(B){var C={listId:A,taskId:B.shift(),forceUpdate:true,openList:B.length===0,startImmediately:B.length===0};Task.updateTask(C,function(){if(B.length>0){z(B)}})}});y.on("click","button",function(){w(false)})}}function g(){var w=this.dataset.action.toLowerCase(),u=Task.view.getCheckedItems(),s=List.getLastActive().id;if(u.length===0){k();return}d(true);EditMode.preventDisabling(true);r(u);function r(x){var z=x.shift(),y=Task.view[w+"Item"](z,true);if(w==="unindent"&&y&&y.nextNodesIds.length>0){y.nextNodesIds.reverse();t(y.nextNodesIds,y.id)}else{v(y)}}function t(x,z){var y=x.shift();Task.moveTask(s,y,z,null,false,function(){if(x.length>0){t(x)}else{v()}})}function v(y){if(!y){x();return}Task.moveTask(s,y.id,y.parentId,y.previousId,false,function(){x()});function x(){if(u.length>0){r(u)}else{App.startSyncQueue();EditMode.preventDisabling(false);d(false)}}}}function e(){h.el.removeClass().addClass("edit");m(true)}function a(){h.el.removeClass("edit");m(false)}function m(r){if(r){h.list.append('<li class="dummy"></li>');h.list.find(".danger").show();h.list.find(".pack-checkbox:not(.danger)").hide();h.list.addClass("edit-mode")}else{h.list.find(".danger").hide().find('input[type="checkbox"]').prop("checked",false);h.list.find(".dummy").remove();h.list.find(".pack-checkbox:not(.danger)").show();h.list.find("."+j).removeClass(j);Task.view.getCheckedItems();h.list.removeClass("edit-mode")}}function c(r){h.el.find(".selected_num").html(r.toString())}function k(){utils.status.show("No tasks were selected",1000)}function d(r){if(r){h.btnIndent[0].disabled=true;h.btnUnindent[0].disabled=true;h.btnMove[0].disabled=true;h.btnDelete[0].disabled=true}else{h.btnIndent[0].disabled=false;h.btnUnindent[0].disabled=false;h.btnMove[0].disabled=false;h.btnDelete[0].disabled=false}}return{init:function(){q()},enable:function(){l=true;App.stopAutoFetch();Task.preventNextDelayedFetch();List.preventOnLoadRefresh();c(0);e()},disable:function(){if(n||!l){return}l=false;App.setAutoFetch();a()},preventDisabling:function(r){n=r}}}(jQuery));