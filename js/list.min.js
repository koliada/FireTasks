window.List=function(){var n,e={CREATE:"createList",RENAME:"renameList",DELETE:"deleteList"},j="lists",g="-",b;function l(){EV.listen("list-selected",d);EV.listen("list-renamed",Task.loadData);EV.listen("list-removed",f);EV.listen("list-not-found",f)}function a(){for(var o in e){if(e.hasOwnProperty(o)){Sync.action(e[o],null).onStart(function(){List.view.toggleProgress(true)}).onFinish(function(){List.view.toggleProgress(false)})}}}function c(o){return o.sort(function(q,p){if(q.title.toLowerCase()<p.title.toLowerCase()){return -1}if(q.title.toLowerCase()>p.title.toLowerCase()){return 1}return 0})}function d(o){try{if(o){n=o;localStorage.setItem("lastListId",o.id)}}catch(p){Logger.log(p)}}function m(o,p){if(typeof o==="undefined"){return}List.storage.get(null,function(q){for(var r=0;r<q.length;r++){if(o===q[r].id){if(q[r-1]){p&&p(q[r-1])}else{p&&p(q[r+1])}}}})}function f(o){if(List.view.getActionChooserList().id===List.getLastActive().id){localStorage.removeItem("lastListId");n=null;m(o,function(p){List.storage.remove(o,function(){Task.setDelayedFetch();Task.loadData(p)})})}else{List.storage.remove(o)}}function k(o){o=o||[];EV.fire("lists-loaded",o)}function i(o){try{var r=true,q=List.getLastActive();for(var p=0;p<o.length;p++){if(o[p].id===q.id){d(o[p]);r=false;break}}r&&d(o[0])}catch(s){Logger.log(s)}}function h(){if(!Settings.get("syncOnStart")){Logger.info("onStart refresh won't start because of the setting");return}b=setTimeout(function(){List.getList()},2000)}return{init:function(){l();a();h()},loadData:function(o){if(o){i(o);k(o);return}List.storage.get(null,function(p){if(p){i(p);k(p)}else{App.runSetup()}})},getList:function(p){List.view.toggleProgress(true);var o={type:"GET",url:"https://www.googleapis.com/tasks/v1/users/@me/lists"};Auth.makeRequest(o,function(s,r){if(!s){List.view.toggleProgress(false);console.error("Error caught!");return}var q=r.items||[];q=c(q);if(p){p(q);return}List.storage.refresh(q,function(t){Task.getList(List.getLastActive(),function(){k(t)},true)})})},preventOnLoadRefresh:function(){Logger.info("onStart lists refresh prevented");clearTimeout(b)},storage:{clear:function(o){localforage.removeItem(j+g+Settings.get("email"),o)},set:function(o,p){localforage.setItem(j+g+Settings.get("email"),o,p)},refresh:function(o,p){List.storage.get(null,function(r){if(!r){App.runSetup();return}var u=List.getLastActive();for(var t=0;t<r.length;t++){var v=true;for(var s=0;s<o.length;s++){if(r[t].id===o[s].id){o[s].tasks=r[t].tasks||[];r[t]=o[s];if(u.id===r[t].id){d(r[t])}o.splice(s,1);s--;v=false;break}}if(v){if(u.id===r[t].id){if(r[t-1]){d(r[t-1])}else{d(r[t+1])}}r.splice(t,1);t--}}for(var q=0;q<o.length;q++){r.push(o[q])}r=c(r);List.storage.set(r,p)})},get:function(o,p){if(!o){localforage.getItem(j+g+Settings.get("email"),p);return}localforage.getItem(j+g+Settings.get("email"),function(q){if(!q){p();return}for(var r=0;r<q.length;r++){if(q[r].id===o){p&&p(q[r]);break}}})},add:function(o,p){List.storage.get(null,function(q){q.push(o);q=c(q);List.storage.set(q,p)})},update:function(o,p,q){o=o||List.getLastActive().id;List.storage.get(null,function(r){for(var s=0;s<r.length;s++){if(r[s].id===o){for(var u in p){if(p.hasOwnProperty(u)){r[s][u]=p[u]}}var t=r[s];d(t);r=c(r);break}}localforage.setItem(j+g+Settings.get("email"),r,function(){q&&q(t)})})},remove:function(o,p){List.storage.get(null,function(q){for(var r=0;r<q.length;r++){if(q[r].id===o){q.splice(r,1);List.storage.set(q,p);break}}})}},getLastActive:function(){return n||{id:localStorage.getItem("lastListId")}},createList:function(o){List.view.toggleProgress(true);var p={type:"POST",url:"https://www.googleapis.com/tasks/v1/users/@me/lists",pack:{title:o}};Auth.makeRequest(p,function(r,q){List.view.toggleProgress(false);if(typeof q.id!=="undefined"){List.storage.add(q,function(s){d(q);List.loadData(s)})}})},renameList:function(o,q){var p={type:"PATCH",url:"https://www.googleapis.com/tasks/v1/users/@me/lists/"+o,pack:{title:q},entity:{type:App.getEntityTypes().LIST,id:o}};Sync.task({actionName:e.RENAME,data:p})[0].start();List.storage.update(o,p.pack,function(r){EV.fire("list-renamed",r)})},deleteList:function(o){var p={type:"DELETE",url:"https://www.googleapis.com/tasks/v1/users/@me/lists/"+o,entity:{type:App.getEntityTypes().LIST,id:o}};Sync.task({actionName:e.DELETE,data:p})[0].start();EV.fire("list-removed",o)},pauseSync:function(){for(var o in e){if(e.hasOwnProperty(o)){Sync.pause(o)}}}}}();