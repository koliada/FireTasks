window.List=function(){var m,e={CREATE:"createList",RENAME:"renameList",DELETE:"deleteList"},i="lists",g="-",b;function k(){EV.listen("list-selected",d);EV.listen("list-renamed",Task.loadData);EV.listen("list-removed",f);EV.listen("list-not-found",f)}function a(){for(var n in e){if(e.hasOwnProperty(n)){Sync.action(e[n],null).onStart(function(){List.view.toggleProgress(true)}).onFinish(function(){List.view.toggleProgress(false)})}}}function c(n){return n.sort(function(p,o){if(p.title.toLowerCase()<o.title.toLowerCase()){return -1}if(p.title.toLowerCase()>o.title.toLowerCase()){return 1}return 0})}function d(n){try{if(n){m=n;localStorage.setItem("lastListId",n.id)}}catch(o){Logger.log(o)}}function l(n,o){if(typeof n==="undefined"){return}List.storage.get(null,function(p){for(var q=0;q<p.length;q++){if(n===p[q].id){if(p[q-1]){o&&o(p[q-1])}else{o&&o(p[q+1])}}}})}function f(n){if(List.view.getActionChooserList().id===List.getLastActive().id||n===List.getLastActive().id){localStorage.removeItem("lastListId");m=null;l(n,function(o){FT.toggleSidebar(true);List.storage.remove(n,function(){Task.loadData(o)})})}else{List.storage.remove(n)}}function j(n){n=n||[];EV.fire("lists-loaded",n)}function h(n){try{var q=true,p=List.getLastActive();for(var o=0;o<n.length;o++){if(n[o].id===p.id){d(n[o]);q=false;break}}q&&d(n[0])}catch(r){Logger.log(r)}}return{init:function(){k();a()},loadData:function(n){if(n){h(n);j(n);return}List.storage.get(null,function(o){if(o){h(o);j(o)}else{FT.runSetup()}})},getList:function(o){List.view.toggleProgress(true);var n={type:"GET",url:"https://www.googleapis.com/tasks/v1/users/@me/lists"};Auth.makeRequest(n,function(r,q){if(!r){List.view.toggleProgress(false);console.error("Error caught!");return}var p=q.items||[];p=c(p);if(o){o(p);return}List.storage.refresh(p,function(s){Task.getList(List.getLastActive(),function(){j(s)},true)})})},getById:function(n,p){var o={type:"GET",url:"https://www.googleapis.com/tasks/v1/users/@me/lists/"+n,entity:{type:FT.getEntityTypes().LIST,id:n}};Auth.makeRequest(o,function(r,q){if(r){p&&p(q)}else{EV.fire("list-not-found",n);p&&p(null)}})},storage:{clear:function(n){localforage.removeItem(i+g+Settings.get("email"),n)},set:function(n,o){localforage.setItem(i+g+Settings.get("email"),n,o)},refresh:function(n,o){List.storage.get(null,function(q){if(!q){FT.runSetup();return}var t=List.getLastActive();for(var s=0;s<q.length;s++){var u=true;for(var r=0;r<n.length;r++){if(q[s].id===n[r].id){n[r].tasks=q[s].tasks||[];q[s]=n[r];if(t.id===q[s].id){d(q[s])}n.splice(r,1);r--;u=false;break}}if(u){if(t.id===q[s].id){if(q[s-1]){d(q[s-1])}else{d(q[s+1])}}q.splice(s,1);s--}}for(var p=0;p<n.length;p++){q.push(n[p])}q=c(q);List.storage.set(q,o)})},get:function(n,o){if(!n){localforage.getItem(i+g+Settings.get("email"),o);return}localforage.getItem(i+g+Settings.get("email"),function(p){if(!p){o();return}for(var q=0;q<p.length;q++){if(p[q].id===n){o&&o(p[q]);break}}})},add:function(n,o){List.storage.get(null,function(p){p.push(n);p=c(p);List.storage.set(p,o)})},update:function(n,o,p){n=n||List.getLastActive().id;List.storage.get(null,function(q){for(var r=0;r<q.length;r++){if(q[r].id===n){for(var t in o){if(o.hasOwnProperty(t)){q[r][t]=o[t]}}var s=q[r];d(s);q=c(q);break}}localforage.setItem(i+g+Settings.get("email"),q,function(){p&&p(s)})})},remove:function(n,o){List.storage.get(null,function(p){for(var q=0;q<p.length;q++){if(p[q].id===n){p.splice(q,1);List.storage.set(p,o);break}}})}},getLastActive:function(){return m||{id:localStorage.getItem("lastListId")}},createList:function(n){List.view.toggleProgress(true);var o={type:"POST",url:"https://www.googleapis.com/tasks/v1/users/@me/lists",pack:{title:n}};Auth.makeRequest(o,function(q,p){List.view.toggleProgress(false);if(typeof p.id!=="undefined"){List.storage.add(p,function(r){d(p);List.loadData(r)})}})},renameList:function(n,p){var o={type:"PATCH",url:"https://www.googleapis.com/tasks/v1/users/@me/lists/"+n,pack:{title:p},entity:{type:FT.getEntityTypes().LIST,id:n}};Sync.task({actionName:e.RENAME,data:o})[0].start();List.storage.update(n,o.pack,function(q){EV.fire("list-renamed",q)})},deleteList:function(n){var o={type:"DELETE",url:"https://www.googleapis.com/tasks/v1/users/@me/lists/"+n,entity:{type:FT.getEntityTypes().LIST,id:n}};Sync.task({actionName:e.DELETE,data:o})[0].start();EV.fire("list-removed",n)},pauseSync:function(){for(var n in e){if(e.hasOwnProperty(n)){Sync.pause(n)}}}}}();