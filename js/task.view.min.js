Task.view=(function(i){var z={LBL_CREATE:"Create",LBL_UPDATE:"Update",LBL_LOADING:"Loading tasks..."},y={drawer:i("section#drawer"),list:i("#tasks").find("ol").first(),form:i("#task-form"),progressBar:i("#progress-tasks"),btnActions:i("#btn-tasks-actions"),btnNewTask:i("#btn-new-task"),btnBack:i("#btn-task-form-back"),btnOk:i("#btn-task-form-ok"),btnDelete:i("#btn-task-form-delete")};function m(){EV.listen("list-renamed",s);EV.listen("list-selected",function(){s()});EV.listen("tasks-loaded",o);EV.listen("tasks-rendered",function(){s(List.getLastActive())});EV.listen("task-updated",A);EV.listen("task-mark-completed",f);EV.listen("task-removed",w);y.drawer.on("click",e);y.list.on("change",'.pack-checkbox:not(.danger) input[type="checkbox"]',k);y.btnActions.on("click",function(){App.showInDevelopmentTooltip()});y.btnNewTask.on("click",q);y.btnDelete.on("click",b);y.btnBack.on("click",C);y.btnOk.on("click",p);y.form.find('[name="due"]').parents("label").first().click(function(D){D.preventDefault();App.showInDevelopmentTooltip()})}function B(F){var D=document.createElement("li"),E=document.createElement("a"),H=document.createElement("label"),J=document.createElement("label"),K=document.createElement("div"),G=document.createElement("label"),I=document.createElement("ol");D.classList.add("task-item");if(F.status==="completed"){D.classList.add("completed")}E.dataset.id=F.id;E.setAttribute("draggable","false");J.className="pack-checkbox danger";J.innerHTML='<input type="checkbox"><span></span>';H.className="pack-checkbox";H.innerHTML='<input type="checkbox" '+((F.status==="completed")?"checked":"")+"><span></span>";K.classList.add("clickable");K.innerHTML='<p class="item-title"><span>'+F.title+"</span></p>"+((!F.notes||F.notes=="")?"":'<p class="item-notes">'+F.notes+"</p>");Longpress.bindLongPressHandler(K,400,g,x,EditMode.isEnabled);G.classList.add("task-handle");G.innerHTML='<div class="action-icon menu"></div>';if(typeof F.children!=="undefined"&&F.children.length!==0){F.children.forEach(function(L){I.appendChild(B(L))})}E.appendChild(J);E.appendChild(H);E.appendChild(K);E.appendChild(G);D.appendChild(E);D.appendChild(I);return D}function h(F){var E=i(F).find("a").first().attr("data-id"),G=v(E),H=d(E),D=List.getLastActive().id;Task.moveTask(D,E,H,G,true)}function d(D){return y.list.find('li.task-item a[data-id="'+D+'"]').first().parent("li.task-item").parents("li.task-item").first().find("a").first().attr("data-id")||null}function v(D){return y.list.find('li.task-item a[data-id="'+D+'"]').first().parent("li.task-item").prev("li").find("a").first().attr("data-id")||null}function l(){y.list.sortable({connectWith:y.list,items:".task-item",handle:".task-handle",axis:"y",placeholder:"sortable-placeholder",scrollSensitivity:70,update:function(D,E){h(E.item[0]);App.setAutoFetch()},start:function(E,F){EditMode.disable();App.stopAutoFetch();var D=i(F.item[0]).find("li");if(D.length>0){i(F.item[0]).find(".item-title").first().prepend('<span class="item-children-num">(+'+D.length+" more) </span>");D.hide();i(this).sortable("refreshPositions");i(F.item[0]).css("height","auto")}i(".sortable-placeholder").css("height",parseInt(window.getComputedStyle(F.item[0],null)["height"]))},change:function(D,E){i(E.item[0]).css("width",i(E.placeholder[0]).css("width"));i(E.item[0]).offset({left:i(E.placeholder[0]).offset().left})},stop:function(E,F){var D=i(F.item[0]).find("li");D.show();i(F.item[0]).find(".item-children-num").remove();i(F.item[0]).css("height","auto");i(this).sortable("refreshPositions")}})}function a(){return y.list.find("li.task-item a:not(:hidden)").length}function j(D){return y.list.find('a[data-id="'+D+'"]').parent("li.task-item")}function n(D){return D.find("[data-id]").first().attr("data-id")}function u(G,F){y.form.find("input").val("");y.form.find("textarea").val("");if(G==="CREATE"){F.ok=z.LBL_CREATE;F.h1="Create Task";F.completed=false;F.due_date=""}if(G==="UPDATE"){F.ok=z.LBL_UPDATE;F.h1="Edit Task"}y.form.find("h1").html(F.h1);y.btnOk.html(F.ok).attr("data-action",G);y.form.find('input[name="title"]').val(F.title);y.form.find('input[name="completed"]').prop("checked",(!!F.completed));y.form.find('textarea[name="notes"]').val(F.notes);y.form.find('input[name="due"]').val(F.due_date);if(typeof F.id!=="undefined"){y.btnDelete.show()[0].dataset.id=F.id;y.btnOk[0].dataset.id=F.id}else{y.btnDelete.hide()}var D=y.form.find('select[name="listId"]'),E=List.getLastActive().id;D.html("");List.storage.get(null,function(H){for(var I=0;I<H.length;I++){var J=(H[I].id===E)?" selected":"";D.append('<option value="'+H[I].id+'"'+J+">"+H[I].title+"</option>")}r()})}function r(){y.form.removeClass().addClass("fade-in");App.stopAutoFetch();Task.preventNextDelayedFetch()}function C(){y.form.removeClass().addClass("fade-out");App.setAutoFetch()}function t(){var D={};y.form.find("input, textarea, select").each(function(E,F){if(F.type==="checkbox"){D[F.name]=F.checked;return}D[F.name]=F.value.trim()});return D}function A(D){try{var G=y.list.find('a[data-id="'+D.id+'"]').parent("li")[0],E=B(D);G.parentNode.replaceChild(E,G)}catch(F){}}function f(D){var E=j(D.id);E.find('.pack-checkbox:not(.danger) input[type="checkbox"]')[0].checked=(D.status==="completed");if(D.status==="completed"){E[0].classList.add("completed")}else{E[0].classList.remove("completed")}}function w(D){var E=j(D);E.remove()}function o(D){if(D.length===0){c();return}var F=y.list[0];F.innerHTML="";D.forEach(function(G){F.appendChild(B(G))});for(var E=0;E<2;E++){F.appendChild(document.createElement("br"))}Task.view.toggleProgress(false);l();EV.fire("tasks-rendered")}function c(){y.list.html('<li><a draggable="false"><p style="text-align: center;">This list is empty</p></a></li>');EV.fire("tasks-rendered");Task.view.toggleProgress(false)}function s(E){var D=(E&&E.title)||z.LBL_LOADING;y.drawer.find("header h2").html(D)}function e(){App.toggleSidebar()}function k(){var D=List.getLastActive().id,F=n(i(this).parents("li").first()),E={},G=false;if(this.checked===true){E.status="completed";G=true}else{E.status="needsAction";E.completed=null}var H={taskId:F,pack:E,listId:D,openList:false,forceUpdate:true};Task.updateTask(H,function(){if(!G){App.startSyncQueue();return}Task.storage.get(D,F,function(I){J(I.childrenIds);function J(K){var L=K.shift(),M={taskId:L,pack:{status:"completed"},listId:D,openList:false};if(!L){App.startSyncQueue();return}Task.updateTask(M,function(){if(K.length>0){J(K)}else{App.startSyncQueue()}})}})})}function q(){u("CREATE",{})}function x(F){var E=F.currentTarget,H=i(E).siblings(".danger").first(),D=i(E).parent("a")[0].dataset.id;if(H.is(":visible")){App.switchCheckbox(H.find('input[type="checkbox"]'));return}Task.storage.get(null,D,G);function G(I){try{var J={id:D,title:I.title,completed:I.completed,notes:I.notes||""};u("UPDATE",J)}catch(K){console.error(K)}}}function g(E){var D=E.currentTarget;Task.storage.get(null,D.parentElement.dataset.id,function(F){EditMode.enable();EditMode.selectNode(F.id,true)})}function b(){var E=this.dataset.id,D=List.getLastActive().id;var F={h1:"Delete Task",p:"This task will be deleted. Continue?",cancel:"Cancel",ok:"Delete",action:function(){C();var G={listId:D,taskId:E,startImmediately:true};Task.deleteTask(G)}};App.confirm(F)}function p(){var G=i(this).attr("data-id"),D=i(this).attr("data-action"),E=t();if(E.completed){E.status="completed";delete E.completed}else{E.status="needsAction";E.completed=null}var F={taskId:G||null,pack:E,listId:E.listId,openList:true,forceUpdate:true,startImmediately:true};delete F.pack.listId;delete F.pack.due;C();if(E.title!=""){if(D==="CREATE"){Task.createTask(F)}if(D==="UPDATE"){Task.updateTask(F)}}}m();return{toggleProgress:function(D){y.btnActions.prop("disabled",D);if(D){y.progressBar.show()}else{y.progressBar.hide()}},indentItem:function(E){var F=j(E),D=F.prev("li"),H=D.find("ol").first().children("li"),G=H.length;if(D.length===0){return null}D.find("ol").first().append(F);return{id:E,parentId:n(D),previousId:n(i(H[G-1]))}},unindentItem:function(G,F){var H=j(G),D=H.parents("li").first(),J=H.nextAll("li"),I=D.parent("ol"),E=[];F=F||false;if(I.length===0){return null}if(F&&J.length>0){J.each(function(L,K){H.find("ol").first().append(i(K));E.push(n(i(K)))})}D.after(H);return{id:G,parentId:n(I.parent("li")),previousId:n(D),nextNodesIds:E}},hideNode:function(D){j(D).find("a").first().hide();if(a()===0){c()}},getCheckedItems:function(){var D=[];y.list.find('.pack-checkbox.danger input[type="checkbox"]:checked').each(function(E,F){D.push(i(F).parents("a").first().attr("data-id"))});return D},getListEl:function(){return y.list}}}(jQuery));