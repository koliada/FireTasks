Task.view=(function(B){var j={LBL_CREATE:"Create",LBL_UPDATE:"Update",LBL_LOADING:"Loading tasks..."},c={drawer:B("section#drawer"),list:B("#tasks").find("ol").first(),form:B("#task-form"),progressBar:B("#progress-tasks"),actionChooser:B("#tasks-actions"),sortModeChooser:B("#tasks-sort-mode"),btnSortTasks:B("#btn-sort-tasks"),btnSortTasksMyOrder:B("#btn-sort-tasks-my-order"),btnSortTasksAlphabetical:B("#btn-sort-tasks-alphabetical"),btnSortTasksDueDate:B("#btn-sort-tasks-due-date"),btnShareTasks:B("#btn-share-tasks"),btnActions:B("#btn-tasks-actions"),btnNewTask:B("#btn-new-task"),btnBack:B("#btn-task-form-back"),btnOk:B("#btn-task-form-ok"),btnDelete:B("#btn-task-form-delete")};var H=(function(){var P,O={myOrder:"MY-ORDER",alphabetical:"ALPHABETICAL",dueDate:"DUE-DATE"},Q="tasksSortMode";return{set:function(R){if(typeof R==="undefined"){R=H.get();if(R===null||typeof R==="undefined"){localStorage.setItem(Q,O.myOrder);P=O.myOrder}}else{var T=false;for(var S in O){if(!O.hasOwnProperty(S)){continue}if(O[S]===R){T=true;break}}if(!T){throw"Unrecognized sorting mode passed, expected values: MY-ORDER|ALPHABETICAL|DUE-DATE"}localStorage.setItem(Q,R);P=R}},get:function(){return(typeof P==="undefined")?localStorage.getItem(Q):P},getSortModes:function(){return O},isMyOrder:function(){return this.get()===O.myOrder},isAlphabetical:function(){return this.get()===O.alphabetical},isDueDate:function(){return this.get()===O.dueDate}}}());function m(){EV.listen("list-renamed",k);EV.listen("list-selected",function(){k()});EV.listen("tasks-loaded",G);EV.listen("tasks-rendered",function(){k(List.getLastActive())});EV.listen("task-updated",F);EV.listen("task-mark-completed",q);EV.listen("task-removed",h);c.list.on("click",r);c.list.on("change",'.pack-checkbox:not(.danger) input[type="checkbox"]',f);c.btnActions.on("click",d);c.btnNewTask.on("click",i);c.btnDelete.on("click",u);var P=c.actionChooser[0].querySelectorAll("button");for(var O=0;O<P.length;O++){P[O].addEventListener("click",v)}P=c.sortModeChooser[0].querySelectorAll("button");for(O=0;O<P.length;O++){P[O].addEventListener("click",a)}c.btnBack.on("click",K);c.btnOk.on("click",I);c.form.find('[name="due"]').parents("label").first().click(function(Q){Q.preventDefault();FT.showInDevelopmentTooltip()})}function N(Q){var O=document.createElement("li"),P=document.createElement("a"),S=document.createElement("label"),U=document.createElement("label"),V=document.createElement("div"),R=document.createElement("label"),T=document.createElement("ol");O.classList.add("task-item");if(Q.status==="completed"){O.classList.add("completed")}P.dataset.id=Q.id;P.setAttribute("draggable","false");P.setAttribute("oncontextmenu","return(false);");U.className="pack-checkbox danger";U.innerHTML='<input type="checkbox"><span></span>';S.className="pack-checkbox";S.innerHTML='<input type="checkbox" '+((Q.status==="completed")?"checked":"")+"><span></span>";V.classList.add("clickable");!H.isMyOrder()&&V.classList.add("not-sortable");V.innerHTML='<p class="item-title"><span>'+Q.title+"</span></p>"+((!Q.notes||Q.notes=="")?"":'<p class="item-notes">'+Q.notes+"</p>");Longpress.bindLongPressHandler(V,400,l,A,EditMode.isEnabled);R.classList.add("task-handle");R.innerHTML='<div class="action-icon menu"></div>';if(H.isMyOrder()&&typeof Q.children!=="undefined"&&Q.children.length!==0){Q.children.forEach(function(W){T.appendChild(N(W))})}P.appendChild(U);P.appendChild(S);P.appendChild(V);H.isMyOrder()&&P.appendChild(R);O.appendChild(P);O.appendChild(T);return O}function z(Q){var P=B(Q).find("a").first().attr("data-id"),R=t(P),S=n(P),O=List.getLastActive().id;Task.moveTask(O,P,S,R,true)}function n(O){return c.list.find('li.task-item a[data-id="'+O+'"]').first().parent("li.task-item").parents("li.task-item").first().find("a").first().attr("data-id")||null}function t(O){return c.list.find('li.task-item a[data-id="'+O+'"]').first().parent("li.task-item").prev("li").find("a").first().attr("data-id")||null}function e(){c.list.sortable({connectWith:c.list,items:".task-item",handle:".task-handle",axis:"y",placeholder:"sortable-placeholder",scrollSensitivity:70,update:function(O,P){z(P.item[0]);FT.setAutoFetch()},start:function(P,Q){EditMode.disable();FT.stopAutoFetch();var O=B(Q.item[0]).find("li");if(O.length>0){B(Q.item[0]).find(".item-title").first().prepend('<span class="item-children-num">(+'+O.length+" more)&nbsp;</span>");O.hide();B(this).sortable("refreshPositions");B(Q.item[0]).css("height","auto")}B(".sortable-placeholder").css("height",parseInt(window.getComputedStyle(Q.item[0],null)["height"]))},change:function(O,P){B(P.item[0]).css("width",B(P.placeholder[0]).css("width"));B(P.item[0]).offset({left:B(P.placeholder[0]).offset().left})},stop:function(P,Q){var O=B(Q.item[0]).find("li");O.show();B(Q.item[0]).find(".item-children-num").remove();B(Q.item[0]).css("height","auto");B(this).sortable("refreshPositions")}})}function y(){return c.list.find("li.task-item a:not(:hidden)").length}function L(O){return c.list.find('a[data-id="'+O+'"]').parent("li.task-item")}function p(O){return O.find("[data-id]").first().attr("data-id")}function b(R,Q){c.form.find("input").val("");c.form.find("textarea").val("");if(R==="CREATE"){Q.ok=j.LBL_CREATE;Q.h1="Create Task";Q.completed=false;Q.due_date=""}if(R==="UPDATE"){Q.ok=j.LBL_UPDATE;Q.h1="Edit Task"}c.form.find("h1").html(Q.h1);c.btnOk.html(Q.ok).attr("data-action",R);c.form.find('input[name="title"]').val(Q.title);c.form.find('input[name="completed"]').prop("checked",(!!Q.completed));c.form.find('textarea[name="notes"]').val(Q.notes);c.form.find('input[name="due"]').val(Q.due_date);if(typeof Q.id!=="undefined"){c.btnDelete.show()[0].dataset.id=Q.id;c.btnOk[0].dataset.id=Q.id}else{c.btnDelete.hide()}var O=c.form.find('select[name="listId"]'),P=List.getLastActive().id;O.html("");List.storage.get(null,function(S){for(var T=0;T<S.length;T++){var U=(S[T].id===P)?" selected":"";O.append('<option value="'+S[T].id+'"'+U+">"+S[T].title+"</option>")}s()})}function s(){c.form.removeClass("fade-out").addClass("fade-in");FT.stopAutoFetch()}function K(){c.form.removeClass("fade-in").addClass("fade-out");FT.setAutoFetch()}function M(){var O={};c.form.find("input, textarea, select").each(function(P,Q){if(Q.type==="checkbox"){O[Q.name]=Q.checked;return}O[Q.name]=Q.value.trim()});return O}function F(O){try{var R=c.list.find('a[data-id="'+O.id+'"]').parent("li")[0],P=N(O);R.parentNode.replaceChild(P,R)}catch(Q){}}function q(O){var P=L(O.id);P.find('.pack-checkbox:not(.danger) input[type="checkbox"]')[0].checked=(O.status==="completed");if(O.status==="completed"){P[0].classList.add("completed")}else{P[0].classList.remove("completed")}}function h(O){var P=L(O);P.remove()}function G(O){if(O.length===0){o();return}Longpress.unbind();var Q=c.list[0];Q.innerHTML="";O=g(O);O.forEach(function(R){Q.appendChild(N(R))});for(var P=0;P<2;P++){Q.appendChild(document.createElement("br"))}Task.view.toggleProgress(false);H.isMyOrder()&&e();EV.fire("tasks-rendered")}function o(){c.list.html('<li><a draggable="false"><p style="text-align: center;">This list is empty</p></a></li>');EV.fire("tasks-rendered");Task.view.toggleProgress(false)}function k(P){var O=(P&&P.title)||j.LBL_LOADING;c.drawer.find("header h2").html(O)}function r(){FT.toggleSidebar()}function f(){var O=List.getLastActive().id,Q=p(B(this).parents("li").first()),P={},R=false;if(this.checked===true){P.status="completed";R=true}else{P.status="needsAction";P.completed=null}var S={taskId:Q,pack:P,listId:O,openList:false,forceUpdate:true};Task.updateTask(S,function(){if(!R){FT.startSyncQueue();return}Task.storage.get(O,Q,function(T){U(T.childrenIds);function U(V){var W=V.shift(),X={taskId:W,pack:{status:"completed"},listId:O,openList:false};if(!W){FT.startSyncQueue();return}Task.updateTask(X,function(){if(V.length>0){U(V)}else{FT.startSyncQueue()}})}})})}function i(){if(!FT.isOnline()){utils.status.show("You are offline.\nUnfortunately, Fire Tasks is unable to create tasks in offline mode at the moment :(",4000);return}b("CREATE",{})}function A(Q){var P=Q.currentTarget,S=B(P).siblings(".danger").first(),O=B(P).parent("a")[0].dataset.id;if(S.is(":visible")){FT.switchCheckbox(S.find('input[type="checkbox"]'));return}Task.storage.get(null,O,R);function R(T){try{var U={id:O,title:T.title,completed:T.completed,notes:T.notes||""};b("UPDATE",U)}catch(V){console.error(V)}}}function l(P){var O=P.currentTarget;Task.storage.get(null,O.parentElement.dataset.id,function(Q){EditMode.enable();EditMode.setNodeChecked(Q.id,true)})}function u(){var P=this.dataset.id,O=List.getLastActive().id;var Q={h1:"Delete Task",p:"This task will be deleted. Continue?",cancel:"Cancel",ok:"Delete",action:function(){K();var R={listId:O,taskId:P,startImmediately:true};Task.deleteTask(R)}};FT.confirm(Q)}function I(){var R=B(this).attr("data-id"),O=B(this).attr("data-action"),P=M();if(P.completed){P.status="completed";delete P.completed}else{P.status="needsAction";P.completed=null}var Q={taskId:R||null,pack:P,listId:P.listId,openList:true,forceUpdate:true,startImmediately:true};delete Q.pack.listId;delete Q.pack.due;K();if(P.title!=""){if(O==="CREATE"){Task.createTask(Q)}if(O==="UPDATE"){Task.updateTask(Q)}}}function g(O){if(H.isAlphabetical()){return O.toPlainArray().sort(function(Q,P){var R=(Q.title.toLowerCase()>=P.title.toLowerCase());return R?1:-1})}else{if(H.isDueDate()){return O.toPlainArray().sort()}else{return O}}}function x(O){if(H.get()===O){Logger.info("setSortMode(): passed sorting mode is already set");return}H.set(O);Task.loadData()}function d(O){FT.stopAutoFetch();c.actionChooser.removeClass("fade-out").addClass("fade-in")}function w(){FT.setAutoFetch();c.actionChooser.removeClass("fade-in").addClass("fade-out")}function C(){FT.stopAutoFetch();c.sortModeChooser.removeClass("fade-out").addClass("fade-in")}function E(){FT.stopAutoFetch();c.sortModeChooser.removeClass("fade-in").addClass("fade-out")}function v(O){switch(O.target.id){case c.btnSortTasks[0].id:J();break;case c.btnShareTasks[0].id:D();break}O.preventDefault();w()}function a(O){switch(O.target.id){case c.btnSortTasksMyOrder[0].id:x(H.getSortModes().myOrder);break;case c.btnSortTasksAlphabetical[0].id:x(H.getSortModes().alphabetical);break;case c.btnSortTasksDueDate[0].id:x(H.getSortModes().dueDate);break}O.preventDefault();E()}function J(){C()}function D(){Task.storage.get(null,null,function(R){R=H.isMyOrder()?R:R.toPlainArray();var P=List.getLastActive().title,Q=P+"\n"+R.toText(Settings.get("ignoreCompletedWhenSharing"));O(new Blob([Q],{type:"text/plain"}),P+".txt")},true);function O(P,R){if(FT.isMozActivityAvailable){new MozActivity({name:"share",data:{number:1,blobs:[P],filenames:[R]}})}else{var Q=window.URL.createObjectURL(P);FT.confirm({h1:"Download file",p:'Use links below to initiate file download.<br/>						<a href="'+Q+'" download="'+R+'">Download "'+R+'"</a><br/>						<a href="'+location.href+'" onclick="window.open(\''+Q+"');\">Alternative link</a>",ok:"Done",recommend:true,hideCancel:true,action:function(){window.URL.revokeObjectURL(P)}})}}}H.set();m();return{toggleProgress:function(O){c.btnActions.prop("disabled",O);c.btnNewTask.prop("disabled",O);if(O){c.progressBar.show()}else{c.progressBar.hide()}},indentItem:function(P){var Q=L(P),O=Q.prev("li"),S=O.find("ol").first().children("li"),R=S.length;if(O.length===0){return null}O.find("ol").first().append(Q);return{id:P,parentId:p(O),previousId:p(B(S[R-1]))}},unindentItem:function(R,Q){var S=L(R),O=S.parents("li").first(),U=S.nextAll("li"),T=O.parent("ol"),P=[];Q=Q||false;if(T.length===0){return null}if(Q&&U.length>0){U.each(function(W,V){S.find("ol").first().append(B(V));P.push(p(B(V)))})}O.after(S);return{id:R,parentId:p(T.parent("li")),previousId:p(O),nextNodesIds:P}},hideNode:function(O){L(O).find("a").first().hide();if(y()===0){o()}},getListEl:function(){return c.list},getSortModeManager:function(){return H}}}(jQuery));