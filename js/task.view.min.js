Task.view=(function(h){var z={LBL_CREATE:"Create",LBL_UPDATE:"Update",LBL_LOADING:"Loading tasks..."},y={drawer:h("section#drawer"),list:h("#tasks").find("ol").first(),form:h("#task-form"),progressBar:h("#progress-tasks"),btnEditMode:h("#btn-edit-tasks"),btnNewTask:h("#btn-new-task"),btnBack:h("#btn-task-form-back"),btnOk:h("#btn-task-form-ok"),btnDelete:h("#btn-task-form-delete")};function l(){EV.listen("list-renamed",s);EV.listen("list-selected",function(){s()});EV.listen("tasks-loaded",n);EV.listen("tasks-rendered",function(){s(List.getLastActive())});EV.listen("task-updated",A);EV.listen("task-mark-completed",f);EV.listen("task-removed",w);y.drawer.on("click",e);y.list.on("change",'.pack-checkbox:not(.danger) input[type="checkbox"]',j);y.list.on("click","a div.clickable",x);y.btnNewTask.on("click",q);y.btnDelete.on("click",b);y.btnBack.on("click",B);y.btnOk.on("click",p);y.form.find('[name="due"]').parents("label").first().click(function(C){C.preventDefault();App.showInDevelopmentTooltip()})}function o(C){var F=(C.status==="completed")?"completed ":"",G=(C.status==="completed")?"checked":"",I=(typeof C.due==="undefined")?"":'<span class="item-due">Due date: '+C.due+"</span>",E=(!C.notes||C.notes=="")?"":'<p class="item-notes">'+C.notes+"</p>",H='<label class="task-handle"><div class="action-icon menu"></div></label>';var D="";D+='<li class="'+F+'task-item">				<a href="#" data-id="'+C.id+'" draggable="false">				<label class="pack-checkbox danger">					<input type="checkbox">					<span></span>				</label>				<label class="pack-checkbox">					<input type="checkbox" '+G+'>					<span></span>				</label>				<div class="clickable"><p class="item-title">'+C.title+"</p>"+E+"</div>"+H+"</a>			<ol>";if(typeof C.children!=="undefined"&&C.children.length!==0){h.each(C.children,function(J,K){D+=o(K)})}D+="</ol></li>";return D}function g(E){var D=h(E).find("a").first().attr("data-id"),F=v(D),G=d(D),C=List.getLastActive().id;Task.moveTask(C,D,G,F,true)}function d(C){return y.list.find('li.task-item a[data-id="'+C+'"]').first().parent("li.task-item").parents("li.task-item").first().find("a").first().attr("data-id")||null}function v(C){return y.list.find('li.task-item a[data-id="'+C+'"]').first().parent("li.task-item").prev("li").find("a").first().attr("data-id")||null}function k(){y.list.sortable({connectWith:y.list,items:".task-item",handle:".task-handle",axis:"y",placeholder:"sortable-placeholder",scrollSensitivity:70,update:function(C,D){g(D.item[0]);App.setAutoFetch()},start:function(D,E){EditMode.disable();App.stopAutoFetch();var C=h(E.item[0]).find("li");if(C.length>0){h(E.item[0]).find(".item-title").first().prepend('<span class="item-children-num">(+'+C.length+" more) </span>");C.hide();h(this).sortable("refreshPositions");h(E.item[0]).css("height","auto")}h(".sortable-placeholder").css("height",parseInt(window.getComputedStyle(E.item[0],null)["height"]))},change:function(C,D){h(D.item[0]).css("width",h(D.placeholder[0]).css("width"));h(D.item[0]).offset({left:h(D.placeholder[0]).offset().left})},stop:function(D,E){var C=h(E.item[0]).find("li");C.show();h(E.item[0]).find(".item-children-num").remove();h(E.item[0]).css("height","auto");h(this).sortable("refreshPositions")}})}function a(){return y.list.find("li.task-item a:not(:hidden)").length}function i(C){return y.list.find('a[data-id="'+C+'"]').parent("li.task-item")}function m(C){return C.find("[data-id]").first().attr("data-id")}function u(F,E){y.form.find("input").val("");y.form.find("textarea").val("");if(F==="CREATE"){E.ok=z.LBL_CREATE;E.h1="Create Task";E.completed=false;E.due_date=""}if(F==="UPDATE"){E.ok=z.LBL_UPDATE;E.h1="Edit Task"}y.form.find("h1").html(E.h1);y.btnOk.html(E.ok).attr("data-action",F);y.form.find('input[name="title"]').val(E.title);y.form.find('input[name="completed"]').prop("checked",(!!E.completed));y.form.find('textarea[name="notes"]').val(E.notes);y.form.find('input[name="due"]').val(E.due_date);if(typeof E.id!=="undefined"){y.btnDelete.show()[0].dataset.id=E.id;y.btnOk[0].dataset.id=E.id}else{y.btnDelete.hide()}var C=y.form.find('select[name="listId"]'),D=List.getLastActive().id;C.html("");List.storage.get(null,function(G){for(var H=0;H<G.length;H++){var I=(G[H].id===D)?" selected":"";C.append('<option value="'+G[H].id+'"'+I+">"+G[H].title+"</option>")}r()})}function r(){y.form.removeClass().addClass("fade-in");App.stopAutoFetch();Task.preventNextDelayedFetch()}function B(){y.form.removeClass().addClass("fade-out");App.setAutoFetch()}function t(){var C={};y.form.find("input, textarea, select").each(function(D,E){if(E.type==="checkbox"){C[E.name]=E.checked;return}C[E.name]=E.value.trim()});return C}function A(C){try{var F=y.list.find('a[data-id="'+C.id+'"]').parent("li")[0],D=h(o(C))[0];F.parentNode.replaceChild(D,F)}catch(E){}}function f(C){var D=i(C.id);D.find('.pack-checkbox:not(.danger) input[type="checkbox"]')[0].checked=(C.status==="completed");if(C.status==="completed"){D[0].classList.add("completed")}else{D[0].classList.remove("completed")}}function w(C){var D=i(C);D.remove()}function n(C){if(C.length===0){c();return}y.list.html("");var D="";h.each(C,function(E,F){D+=o(F)});D+="<br />";y.list.append(D);Task.view.toggleProgress(false);k();EV.fire("tasks-rendered")}function c(){y.list.html('<li><a draggable="false"><p style="text-align: center;">This list is empty</p></a></li>');EV.fire("tasks-rendered");Task.view.toggleProgress(false)}function s(D){var C=(D&&D.title)||z.LBL_LOADING;y.drawer.find("header h2").html(C)}function e(){App.toggleSidebar()}function j(){var C=List.getLastActive().id,E=m(h(this).parents("li").first()),D={},F=false;if(this.checked===true){D.status="completed";F=true}else{D.status="needsAction";D.completed=null}var G={taskId:E,pack:D,listId:C,openList:false,forceUpdate:true};Task.updateTask(G,function(){if(!F){App.startSyncQueue();return}Task.storage.get(C,E,function(H){I(H.childrenIds);function I(J){var K=J.shift(),L={taskId:K,pack:{status:"completed"},listId:C,openList:false};if(!K){App.startSyncQueue();return}Task.updateTask(L,function(){if(J.length>0){I(J)}else{App.startSyncQueue()}})}})})}function q(){u("CREATE",{})}function x(){var E=h(this).siblings(".danger").first(),C=h(this).parent("a")[0].dataset.id;if(E.is(":visible")){App.switchCheckbox(E.find('input[type="checkbox"]'));return}Task.storage.get(null,C,D);function D(F){try{var G={id:C,title:F.title,completed:F.completed,notes:F.notes||""};u("UPDATE",G)}catch(H){console.error(H)}}}function b(){var D=this.dataset.id,C=List.getLastActive().id;var E={h1:"Delete Task",p:"This task will be deleted. Continue?",cancel:"Cancel",ok:"Delete",action:function(){B();var F={listId:C,taskId:D,startImmediately:true};Task.deleteTask(F)}};App.confirm(E)}function p(){var F=h(this).attr("data-id"),C=h(this).attr("data-action"),D=t();if(D.completed){D.status="completed";delete D.completed}else{D.status="needsAction";D.completed=null}var E={taskId:F||null,pack:D,listId:D.listId,openList:true,forceUpdate:true,startImmediately:true};delete E.pack.listId;delete E.pack.due;B();if(D.title!=""){if(C==="CREATE"){Task.createTask(E)}if(C==="UPDATE"){Task.updateTask(E)}}}l();return{toggleProgress:function(C){y.btnEditMode.prop("disabled",C);if(C){y.progressBar.show()}else{y.progressBar.hide()}},indentItem:function(D){var E=i(D),C=E.prev("li"),G=C.find("ol").first().children("li"),F=G.length;if(C.length===0){return null}C.find("ol").first().append(E);return{id:D,parentId:m(C),previousId:m(h(G[F-1]))}},unindentItem:function(F,E){var G=i(F),C=G.parents("li").first(),I=G.nextAll("li"),H=C.parent("ol"),D=[];E=E||false;if(H.length===0){return null}if(E&&I.length>0){I.each(function(K,J){G.find("ol").first().append(h(J));D.push(m(h(J)))})}C.after(G);return{id:F,parentId:m(H.parent("li")),previousId:m(C),nextNodesIds:D}},hideNode:function(C){i(C).find("a").first().hide();if(a()===0){c()}},getCheckedItems:function(){var C=[];y.list.find('.pack-checkbox.danger input[type="checkbox"]:checked').each(function(D,E){C.push(h(E).parents("a").first().attr("data-id"))});return C},getListEl:function(){return y.list}}}(jQuery));