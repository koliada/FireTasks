window.Task=(function(e){function m(){EV.listen("lists-rendered",Task.loadData);EV.listen("task-not-found",l)}var h=function(n){this.push.apply(this,n);this.toPlainArray=function(){function o(q,p){var s;p=p||[];for(var r=0;r<q.length;r++){s=q[r].children;delete q[r].children;p.push(q[r]);if(s.length>0){p=o(s,p)}}return p}return new h(o(this))};this.toText=function(p){p=(typeof p==="undefined")?true:p;function o(r,u,v){var q="",t,s;u=u||"";for(s=0;s<v;s++){q+=" "}for(s=0;s<r.length;s++){if(p&&r[s].status==="completed"){continue}u+=q+"- "+r[s].title+"\n";if(r[s].notes){u+=q+"  "+r[s].notes+"\n"}t=r[s].children;if(t&&t.length>0){u=o(t,u,++v)}}return u}return o(this,null,0)}};h.prototype=Array.prototype;function g(x){var q,u,n,p,t,w,r,v,s;n=x.id||"id";t=x.parentid||"parent";q=x.children||"children";w={};p=[];s=x.q;for(r=0,v=s.length;r<v;r++){u=s[r];u[q]=[];w[u[n]]=u;if(w[u[t]]!=null){w[u[t]][q].push(u)}else{p.push(u)}}return p}function f(o){function n(r){var q="";if(typeof r!=="undefined"&&typeof r.children!=="undefined"){e.each(r.children,function(s,t){q+=t.id+",";if(typeof t.children!=="undefined"&&t.children.length!==0){q+=n(t)}})}return q}var p=n(o).split(",");p.pop();return p}function i(p,q){if(!q||q.length===0){return null}if(q[0].kind=="tasks#taskList"){for(var o=0;o<q.length;o++){var r=n(p,q[o].tasks);if(r){return r}}}if(q[0].kind=="tasks#task"){return n(p,q)}return null;function n(w,u){for(var s=0;s<u.length;s++){var t=u[s];if(t.id===w){return j(t)}else{if(typeof t.children!=="undefined"&&t.children.length>0){var v=i(w,t.children);if(v&&v.id===w){return j(v)}}}}return null}}function j(n){n.childrenIds=f(n);return n}function b(p,s,t){if(!t||t.length===0){return null}for(var o=0;o<t.length;o++){if(t[o].id===p){for(var r in s){if(s.hasOwnProperty(r)){t[o][r]=s[r];if(r==="status"){if(s[r]==="completed"){t[o]["completed"]=new Date()}else{if(s[r]==="needsAction"){delete t[o]["completed"]}}}}}return t[o]}else{for(var n=0;n<t[o].children.length;n++){var q=b(p,s,[t[o].children[n]]);if(q){return q}}}}return undefined}function c(p,q){if(!q){return null}for(var o=0;o<q.length;o++){if(q[o].id===p){q.splice(o,1);return q}else{if(q[o].children&&q[o].children.length>0){var n=c(p,q[o].children);if(n){q[o].children=n;return q}}}}return null}function d(p,n,s,u,r){for(var q=0;q<n.length;q++){if(n[q].id===p){var t=o(n[q].tasks,s,u,r);if(t){n[q].tasks=t;return n}}}return null;function o(B,v,C,A){if(C){for(var z=0;z<B.length;z++){if(B[z].id===C){if(A){for(var x=0;x<B[z].children.length;x++){if(B[z].children[x].id===A){B[z].children.splice(x+1,0,v);return B}}}else{B[z].children.unshift(v);return B}}var y=o(B[z].children,v,C,A);if(y){B[z].children=y;return B}}return null}if(A){for(var w=0;w<B.length;w++){if(B[w].id===A){B.splice(w+1,0,v);return B}}}B.unshift(v);return B}}function a(p,w,v){var s={},n=List.getLastActive().id;o(w,p.pack,null,null,u);function o(x,z,A,B,C){z=z||x;var y={listId:n,taskId:x.id,moveChildren:false,touchStorage:false};Task.deleteTask(y,function(){var D={listId:p.listId,pack:r(z),openList:false,touchStorage:false};if(A){D.pack.parent=A.id}if(B){D.pack.previous=B.id}Task.createTask(D,function(E){s[x.id]=E;F(x.children,null);function F(G,H){var I=G.shift();if(!I){C&&C(A);return}o(I,null,E,H,function(J){if(G.length>0){F(G,J)}else{C&&C(J)}})}})})}function u(){List.storage.get(null,function(x){for(var z=0;z<x.length;z++){if(x[z].id===n){var y=i(w.id,x[z].tasks);x[z].tasks=c(w.id,x[z].tasks);y=q(y);x=d(p.listId,x,y);if(!x){console.error("Crap! Couldn't insert task. Aborting.");return}if(A){break}}if(x[z].id===p.listId){var A=x[z];if(y){break}}}List.storage.set(x,function(){t(A)})})}function q(x){var B=x.id,y=["notes","completed","due"];for(var A in s[B]){if(s[B].hasOwnProperty(A)){x[A]=s[B][A]}}for(var z in x){if(x.hasOwnProperty(z)){if(!s[B][z]&&y.indexOf(z)>-1){delete x[z]}}}x.children.forEach(function(C){q(C)});return x}function r(y){var z={},A,x=["id","children","childrenIds","parent","previous"];for(A in y){if(y.hasOwnProperty(A)){if(x.indexOf(A)===-1){z[A]=y[A]}}}return z}function t(x){if(p.startImmediately){FT.startSyncQueue()}if(p.openList){Task.loadData(x)}v&&v(x)}}function l(n){Task.storage.get(null,n,function(o){if(o){EV.fire("task-removed",o.id);Task.storage.remove(null,o.id)}})}function k(n){n=n||[];EV.fire("tasks-loaded",new h(n))}return{init:function(){m()},loadData:function(n){n=n||List.getLastActive();EV.fire("list-selected",n);if(n.tasks){k(n.tasks);return}Task.storage.get(n.id,null,function(o){if(o){k(o)}else{Task.getList(n)}})},getList:function(p,q,n){if(typeof n==="undefined"){n=true}p=p||List.getLastActive();Task.view.toggleProgress(true);var o={type:"GET",url:"https://www.googleapis.com/tasks/v1/lists/"+p.id+"/tasks"};Auth.makeRequest(o,function(u,s){if(!u||(u&&arguments[3]=="Not Found")){EV.fire("list-not-found",p.id);return}var r=s.items||[];r=g({q:r});if(n){List.storage.update(p.id,{tasks:r},function(){k(r);t()})}else{t()}function t(){if(q){q(p,r)}}},function(s,r){if(r.status==503){EV.fire("list-not-found",p.id)}else{console.error("Unusual error has occurred");if(typeof q!=="undefined"){q()}else{Task.view.toggleProgress(false)}}})},getById:function(n,o,q){n=n||List.getLastActive().id;var p={type:"GET",url:"https://www.googleapis.com/tasks/v1/lists/"+n+"/tasks/"+o,entity:{type:FT.getEntityTypes().TASK,id:o,listId:n}};Auth.makeRequest(p,function(s,r){if(s){q&&q(r)}else{EV.fire("task-not-found",o);q&&q(null)}})},storage:{get:function(n,o,q,p){n=n||List.getLastActive().id;List.storage.get(n,function(s){var r=s.tasks;if(!o){q(p?new h(r):r);return}r=i(o,r);q((r&&p)?new h(r):r)})},update:function(n,o,p,q){n=n||List.getLastActive().id;List.storage.get(null,function(r){for(var t=0;t<r.length;t++){if(r[t].id===n){var s=b(o,p,r[t].tasks);if(s){break}}}List.storage.set(r,function(){q&&q(s)})})},remove:function(n,o,p){n=n||List.getLastActive().id;List.storage.get(null,function(q){for(var r=0;r<q.length;r++){if(q[r].id===n){if(!o){q[r].tasks=[];List.storage.set(q,p);break}q[r].tasks=c(o,q[r].tasks);List.storage.set(q,p)}}})},insert:function(n,p,r,o,q){n=n||List.getLastActive().id;p.kind=p.kind||"tasks#task";p.children=p.children||[];List.storage.get(null,function(s){for(var t=0;t<s.length;t++){if(s[t].id===n){s=d(n,s,p,r,o);if(!s){console.error("Crap! Couldn't insert task. Aborting.");return}break}}List.storage.set(s,function(u){q&&q(u)})})},move:function(n,o,r,p,q){n=n||List.getLastActive().id;List.storage.get(null,function(t){for(var u=0;u<t.length;u++){if(t[u].id===n){var s=i(o,t[u].tasks);t[u].tasks=c(o,t[u].tasks);t=d(n,t,s,r,p);if(!t){console.error("Crap! Couldn't insert task. Aborting.");return}break}}List.storage.set(t,function(v){q&&q(v)})})}},createTask:function(p,q){if(typeof p.openList==="undefined"){p.openList=true}if(typeof p.touchStorage==="undefined"){p.touchStorage=true}p.parentId=p.parentId||p.pack.parent||null;p.previousId=p.previousId||p.pack.previous||null;var o={type:"POST",url:"https://www.googleapis.com/tasks/v1/lists/"+p.listId+"/tasks",pack:p.pack,entity:{type:FT.getEntityTypes().TASK,id:null,listId:p.listId}};o.query_params="";if(p.previousId!==null){o.query_params+="previous="+p.previousId+"&"}if(p.parentId!==null){o.query_params+="parent="+p.parentId}Task.view.toggleProgress(true);Auth.makeRequest(o,function(s,r){if(s&&r){p.pack=r;n(p,q)}else{Task.view.toggleProgress(false)}});function n(s,t){if(s.touchStorage){Task.storage.insert(s.listId,s.pack,s.parentId,s.previousId,r)}else{r()}function r(){setTimeout(function(){if(s.openList){List.storage.get(s.listId,function(u){Task.loadData(u)})}t&&t(s.pack)},0)}}},updateTask:function(o,p){var n=List.getLastActive().id;Task.storage.get(n,o.taskId,function(q){if(!o.forceUpdate&&q.completed){p&&p();return}if(typeof o.openList==="undefined"){o.openList=true}if(n===o.listId){var r={type:"PATCH",url:"https://www.googleapis.com/tasks/v1/lists/"+o.listId+"/tasks/"+o.taskId,pack:o.pack,entity:{type:FT.getEntityTypes().TASK,id:o.taskId,listId:o.listId}};FT.addSyncTask(r);Task.storage.update(o.listId,o.taskId,o.pack,function(s){if(o.startImmediately){FT.startSyncQueue()}if((Object.keys(o.pack).length===1&&o.pack.status==="completed")||(Object.keys(o.pack).length===2&&o.pack.status==="needsAction"&&o.pack.completed===null)){EV.fire("task-mark-completed",s)}else{EV.fire("task-updated",s)}p&&p()})}else{a(o,q,p)}})},deleteTask:function(p,q){if(typeof p.moveChildren==="undefined"){p.moveChildren=true}if(typeof p.touchStorage==="undefined"){p.touchStorage=true}var o={type:"DELETE",url:"https://www.googleapis.com/tasks/v1/lists/"+p.listId+"/tasks/"+p.taskId,entity:{type:FT.getEntityTypes().TASK,id:p.taskId,listId:p.listId}};FT.addSyncTask(o);Task.view.hideNode(p.taskId);if(p.moveChildren){Task.storage.get(p.listId,p.taskId,function(s){r(s.children.reverse());function r(t){var v=t.shift();if(!v){n();return}var u=Task.view.unindentItem(v.id);Task.moveTask(p.listId,u.id,u.parentId,u.previousId,false,function(){if(t.length>0){r(t)}else{n()}})}})}else{n()}function n(){if(p.touchStorage){Task.storage.remove(p.listId,p.taskId,r)}else{r()}function r(){setTimeout(function(){if(p.startImmediately){FT.startSyncQueue()}EV.fire("task-removed",p.taskId);q&&q(p.taskId)},0)}}},moveTask:function(t,w,s,p,z,y){t=t||List.getLastActive();s=s||null;p=p||null;var n=false,o=false;var r={type:"POST",url:"https://www.googleapis.com/tasks/v1/lists/"+t+"/tasks/"+w+"/move",entity:{type:FT.getEntityTypes().TASK,id:w,listId:t}};r.query_params="";if(p!==null){if(FT.isOnline()){Task.getById(t,p,function(A){if(A&&!A.deleted){x()}else{q()}})}else{x()}}else{n=true}if(s!==null){if(FT.isOnline()){Task.getById(t,s,function(A){if(A&&!A.deleted){u()}else{q()}})}else{u()}}else{o=true}v();function x(){r.query_params+="previous="+p+"&";n=true;v()}function u(){r.query_params+="parent="+s+"&";o=true;v()}function v(){if(!n||!o){return}FT.addSyncTask(r);Task.storage.move(t,w,s,p,function(A){if(z){FT.startSyncQueue()}if(typeof y!=="undefined"){y(A)}})}function q(){if(EditMode.isEnabled()){var B=EditMode.getCheckedItems(),A=EV.listen("tasks-rendered",function(){EditMode.enable();B.forEach(function(C){EditMode.setNodeChecked(C,true)});EV.stopListen(A)})}Task.getList()}}}}(jQuery));