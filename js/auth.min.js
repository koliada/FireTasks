window.Auth=(function(d){var b="",a=0,c={authWaitingDialog:d("#auth-waiting-dialog"),btnReopenDialog:d("#btn-auth-waiting-reopen-dialog")};function e(j){c.authWaitingDialog.removeClass("fade-out").addClass("fade-in");c.btnReopenDialog.on("click",function(){f(j,true)})}function i(){c.authWaitingDialog.removeClass("fade-in").addClass("fade-out");c.btnReopenDialog.off()}function f(n,l){var k;var j=Settings.get("email");if(j){FT.options.email=j}else{FT.options.email=null;l=true}var m=b;GO2.init(FT.options);if(l===true){e(n)}GO2.login(false,(l===false));if(l===false){k=setTimeout(function(){clearTimeout(k);if(m===b){GO2.logout();e(n);GO2.login(false,false);FT.stopAutoFetch()}},5000)}GO2.onlogin=function(o){i();g(o,function(p){if(p){d.ajax({url:"https://www.googleapis.com/oauth2/v1/userinfo?alt=json&access_token="+o,type:"GET",dataType:"json",timeout:10000}).done(function(q){b=o;localStorage.setItem("accessToken",o);if(FT.options.email&&FT.options.email!=q.email){List.storage.clear(function(){alert("You have signed in as different user");FT.runSetup()});return}Settings.set("email",q.email);n&&n(o)}).fail(function(q,s,r){utils.status.show("Something went wrong :(\nRetrying...",2000);GO2.logout();f(n,true)})}})}}function h(l,k){k=k||false;if(k==true){localStorage.removeItem("accessToken");GO2.logout();f(l,k);return}else{var j=localStorage.getItem("accessToken")}if(!j){f(l,k);return}b=j;l&&l(j)}function g(j,k){d.ajax({url:"https://www.googleapis.com/oauth2/v1/tokeninfo",data:{access_token:j},timeout:10000,type:"GET",dataType:"json"}).done(function(l){if(l.audience==FT.options.client_id){k(true)}}).fail(function(l,o,n){var m=l.responseJSON||{};if(typeof m.error!=="undefined"&&m.error=="invalid_token"){utils.status.show("Invalid token")}utils.status.show("An error has occurred while validating the token");k(false)})}return{init:function(){d.ajaxSetup({xhr:function(){return new window.XMLHttpRequest({mozSystem:true,cache:false})}})},dataCalculation:(function(){var j=false,k=0;return{start:function(){k=0;j=true},getStarted:function(){return j},setValue:function(l){k=parseInt(l)||0},getValue:function(l){if(typeof l==="undefined"){l=true}var m=k;if(l){k=0}j=false;return m}}}()),makeRequest:function(k,l,j){if(FT.unrecoverableErrorOccurred()){console.error("Auth has caught unrecoverable error and will not proceed.");return}h(function(q){var m=(typeof k.fields==="undefined")?"":"&fields="+k.fields;var n=(typeof k.query_params!=="undefined")?"?"+k.query_params+"&":"?";var o=k.url+n+"access_token="+q+m;var r=k.type;var p=JSON.stringify(k.pack)||{};d.ajax({url:o,data:p,timeout:10000,type:r,contentType:"application/json; charset=UTF-8",dataType:"json"}).done(function(s,u,t){if(s&&s.deleted){FT.onResourceNotFound(k.entity)}a=0;l(true,s,u,t)}).fail(function(t,v,u){function s(){FT.startSyncQueue();FT.setAutoFetch();Task.view.toggleProgress(true);Auth.makeRequest(k,l,j)}if(t.status==0){List.view.toggleProgress(false);Task.view.toggleProgress(false);EditMode.isEnabled()&&EditMode.enable(false);FT.stopAutoFetch();Sync.clearStarted();if(FT.isOnline()){if(a>1){setTimeout(function(){a--;s()},10000);return}utils.status.show("No connection. Retrying...",1500);Logger.warn("No connection. Retrying...");setTimeout(function(){a++;s()},1000)}else{EV.listen("connection-online",function(){s()})}return}else{if(t.status==401){localStorage.removeItem("accessToken");FT.stopAutoFetch();GO2.logout();h(function(){FT.setAutoFetch();Auth.makeRequest(k,l,j)});return}else{if(t.status==404){FT.onResourceNotFound(k.entity);l(true,null,v,u,k.entity);return}else{if(t.status==403){if(t.responseJSON&&t.responseJSON.error&&t.responseJSON.error.message&&t.responseJSON.error.message=="Daily Limit Exceeded"){utils.status.show("API Daily Limit Exceeded :(",6000);List.view.toggleProgress(false);Task.view.toggleProgress(false);console.error(t.responseJSON.error);return}Auth.makeRequest(k,l,j);return}else{utils.status.show("An error occurred: "+t.status+" - "+t.responseJSON.error.errors[0].message,1000)}}}}if(typeof j!=="undefined"){j(false,t,v,u)}else{l(false,t,v,u)}}).always(function(){var s=(arguments[0]&&arguments[0].getResponseHeader)?arguments[0]:arguments[2];if(Auth.dataCalculation.getStarted()){Auth.dataCalculation.setValue(Auth.dataCalculation.getValue()+(parseInt(s.getResponseHeader("Content-Length")||0)))}})})},revokeToken:function(){h(function(j){d.ajax({url:"https://accounts.google.com/o/oauth2/revoke?token="+j,type:"GET",dataType:"jsonp",timeout:10000,statusCode:{200:function(){alert("Your were successfully logged out");List.storage.clear(function(){localStorage.removeItem("accessToken");localStorage.removeItem("lastListId");Settings.remove("email");b=null;GO2.logout();Settings.hideLayout(false);FT.runSetup()})},400:function(){utils.status.show("Something went wrong :(",4000);Auth.revokeToken()}}})})}}}(jQuery));