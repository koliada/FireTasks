window.Auth=(function(f){var c="",e=0;function b(k,i){var h;var g=Settings.get("email");if(g){FT.options.email=g}else{FT.options.email=null;i=true}var j=c;GO2.init(FT.options);GO2.login(false,(i===false));if(i===false){h=setTimeout(function(){clearTimeout(h);if(j===c){GO2.logout();GO2.login(false,false);FT.stopAutoFetch()}},5000)}GO2.onlogin=function(l){a(l,function(m){if(m){f.ajax({url:"https://www.googleapis.com/oauth2/v1/userinfo?alt=json&access_token="+l,type:"GET",dataType:"json",timeout:10000}).done(function(n){c=l;localStorage.setItem("accessToken",l);if(FT.options.email&&FT.options.email!=n.email){List.storage.clear(function(){alert("You have signed in as different user");FT.runSetup()});return}Settings.set("email",n.email);k&&k(l)}).fail(function(n,p,o){utils.status.show("Something went wrong :(\nRetrying...",2000);GO2.logout();b(k,true)})}})};GO2.oncancel=function(){alert("Fire Tasks requires Google Authentication for proper work. We will add offline mode later.")}}function d(i,h){h=h||false;if(h==true){localStorage.removeItem("accessToken");GO2.logout();b(i,h);return}else{var g=localStorage.getItem("accessToken")}if(!g){b(i,h);return}c=g;i&&i(g)}function a(g,h){f.ajax({url:"https://www.googleapis.com/oauth2/v1/tokeninfo",data:{access_token:g},timeout:10000,type:"GET",dataType:"json"}).done(function(i){if(i.audience==FT.options.client_id){h(true)}}).fail(function(i,l,k){var j=i.responseJSON||{};if(typeof j.error!=="undefined"&&j.error=="invalid_token"){utils.status.show("Invalid token")}utils.status.show("An error has occurred while validating the token");h(false)})}return{init:function(){f.ajaxSetup({xhr:function(){return new window.XMLHttpRequest({mozSystem:true,cache:false})}})},dataCalculation:(function(){var g=false,h=0;return{start:function(){h=0;g=true},getStarted:function(){return g},setValue:function(i){h=parseInt(i)||0},getValue:function(i){if(typeof i==="undefined"){i=true}var j=h;if(i){h=0}g=false;return j}}}()),makeRequest:function(h,i,g){if(FT.unrecoverableErrorOccurred()){console.error("Auth has caught unrecoverable error and will not proceed.");return}d(function(n){var j=(typeof h.fields==="undefined")?"":"&fields="+h.fields;var k=(typeof h.query_params!=="undefined")?"?"+h.query_params+"&":"?";var l=h.url+k+"access_token="+n+j;var o=h.type;var m=JSON.stringify(h.pack)||{};f.ajax({url:l,data:m,timeout:10000,type:o,contentType:"application/json; charset=UTF-8",dataType:"json"}).done(function(p,r,q){if(p&&p.deleted){FT.onResourceNotFound(h.entity)}e=0;i(true,p,r,q)}).fail(function(q,s,r){function p(){FT.startSyncQueue();FT.setAutoFetch();Task.view.toggleProgress(true);Auth.makeRequest(h,i,g)}if(q.status==0){List.view.toggleProgress(false);Task.view.toggleProgress(false);EditMode.isEnabled()&&EditMode.enable(false);FT.stopAutoFetch();Sync.clearStarted();if(FT.isOnline()){if(e>1){setTimeout(function(){e--;p()},10000);return}utils.status.show("No connection. Retrying...",1500);Logger.warn("No connection. Retrying...");setTimeout(function(){e++;p()},1000)}else{EV.listen("connection-online",function(){p()})}return}else{if(q.status==401){localStorage.removeItem("accessToken");FT.stopAutoFetch();GO2.logout();d(function(){FT.setAutoFetch();Auth.makeRequest(h,i,g)});return}else{if(q.status==404){FT.onResourceNotFound(h.entity);i(true,null,s,r,h.entity);return}else{if(q.status==403){if(q.responseJSON&&q.responseJSON.error&&q.responseJSON.error.message&&q.responseJSON.error.message=="Daily Limit Exceeded"){utils.status.show("API Daily Limit Exceeded :(",6000);List.view.toggleProgress(false);Task.view.toggleProgress(false);console.error(q.responseJSON.error);return}Auth.makeRequest(h,i,g);return}else{utils.status.show("An error occurred: "+q.status+" - "+q.responseJSON.error.errors[0].message,1000)}}}}if(typeof g!=="undefined"){g(false,q,s,r)}else{i(false,q,s,r)}}).always(function(){var p=(arguments[0]&&arguments[0].getResponseHeader)?arguments[0]:arguments[2];if(Auth.dataCalculation.getStarted()){Auth.dataCalculation.setValue(Auth.dataCalculation.getValue()+(parseInt(p.getResponseHeader("Content-Length")||0)))}})})},revokeToken:function(){d(function(g){f.ajax({url:"https://accounts.google.com/o/oauth2/revoke?token="+g,type:"GET",dataType:"jsonp",timeout:10000,statusCode:{200:function(){alert("Your were successfully logged out");List.storage.clear(function(){localStorage.removeItem("accessToken");localStorage.removeItem("lastListId");Settings.remove("email");c=null;GO2.logout();Settings.hideLayout(false);FT.runSetup()})},400:function(){utils.status.show("Something went wrong :(",4000);Auth.revokeToken()}}})})}}}(jQuery));