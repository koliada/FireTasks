(function(b,a){var c={};a(c);b.Sync=c}(this,function(k){var f=[],b={},n="koliada.sync",j=["ALL","WARNING","ERROR"],d="WARNING",l={},o={},i=[],a={INFO:"info",WARNING:"warning",ERROR:"error"};k.version="0.1";k.onError=function(p){};function h(p,q){switch(p){case a.INFO:if(["ALL"].indexOf(d)>-1){console.info("Info: ",q)}break;case a.WARNING:if(["ALL","WARNING"].indexOf(d)>-1){console.warn("Warning: ",q)}break;case a.ERROR:if(["ALL","WARNING","ERROR"].indexOf(d)>-1){console.error("Error: ",q)}k.onError(q);break}}function e(p){if(!Array.isArray(p)){p=[p]}return p}function g(q){if(typeof q==="undefined"){var p=localStorage.getItem(n);if(typeof p!=="undefined"){return JSON.parse(p)}else{return undefined}}localStorage.setItem(n,JSON.stringify(q));return true}function m(){var p=g();if(p&&p.length>0){var q=[];f.forEach(function(r){q.push(r.id)});p.forEach(function(r){if(q.indexOf(r.id)===-1){f=e(r).concat(f)}})}}function c(){var p=new Date().getTime();while(p==new Date().getTime()){}return new Date().getTime()}b={actions:{},defaultHandler:function(){h(a.ERROR,{message:"'defaultHandler' not set. Use 'sync.action.setDefaultHandler(func)' or attach separate handler for this Action."})},get:function(p){var r=this.actions;if(typeof p==="undefined"){return r}for(var q in r){if(r.hasOwnProperty(q)){if(q===p){(function(s){r[s].remove=function(){delete r[s];return true}}(q));return r[q]}}}return undefined},set:function(p,r){if(p){var q={func:r||this.defaultHandler,start:function(){Sync.start(p);return q},pause:function(){Sync.pause(p);return q},resume:function(){Sync.resume(p);return q},onStart:function(s){q.onstart=s||new Function;return q},onPause:function(s){q.onpause=s||new Function;return q},onFinish:function(s){q.onfinish=s||new Function;return q}};this.actions[p]=q;this.actions[p].onStart().onPause().onFinish();return this.actions[p]}else{return null}}};k.setStorageVariable=function(p){if(typeof p!=="undefined"){n=p.toString();return true}return false};k.setLogLevel=function(p){if(typeof p==="string"){if(j.indexOf(p)>-1){d=p}else{h(a.WARNING,{eventName:"Sync.setLogLevel",message:"'"+p+"' is not a proper logging level. Possible values: ALL|WARNING|ERROR."})}}};k.action=function(p,q){if(typeof p==="undefined"){return b.get()}if(typeof q==="undefined"){return b.get(p)}return b.set(p,q)};k.action.setDefaultHandler=function(p){if(p){b.defaultHandler=p;return true}return false};k.task=function(r){if(typeof r==="undefined"){r=-1}if(typeof r==="string"||typeof r==="number"){if(r===-1){return f}for(var p=0;p<f.length;p++){if(f[p].id===r.toString()){(function(t){f[t].remove=function(){f.slice(t,1);g(f);return true}}(p));return f[p]}}return undefined}var s=e(r);var q=[];s.forEach(function(t){var v=c().toString();if(t.actionName&&t.data){var u={id:v,actionName:t.actionName,data:t.data,start:function(){Sync.start(this.actionName);return this},pause:function(){Sync.pause(this.actionName);return this},resume:function(){Sync.resume(this.actionName);return this}};f.push(u);q.push(u)}else{h(a.ERROR,{eventName:"Sync.task",message:"'actionName' or 'data' not passed"})}});g(f);return q};k.start=function(p){if(i[p]){h(a.INFO,{actionName:p,eventName:"Sync.start",message:"Queue '"+p+"' already running"});return}if(typeof p==="undefined"){h(a.ERROR,{eventName:"Sync.start",message:"'actionName' not passed"});return}if(o[p]&&o[p]===true){h(a.INFO,{actionName:p,eventName:"Sync.start",message:"Next task halted"});l[p]=null;b.actions[p].onpause();return}if(!l[p]){b.actions[p].onstart()}m();for(var r=0;r<f.length;r++){if(f[r].actionName===p){var q=f.splice(r,1)[0];break}}if(typeof q==="undefined"){h(a.WARNING,{eventName:"Sync.start",message:"No tasks to execute",debugData:{actionName:p,queue:f,currentlyRunning:l[p],storage:g()}});b.actions[p].onfinish();return}l[p]=q.id;i[p]=true;b.actions[q.actionName].func(q.data,function(){var s=Array.prototype.slice.call(arguments),t=s[0];i[p]=null;if(t!==true){h(a.ERROR,{eventName:"Sync.start",message:"Task failed",debugData:{task:q,queue:f,currentlyRunning:l[p],storedTasks:g()}});f.unshift(q);k.start(p);return}if(t===true){g(f);if(f.length>0){k.start(p)}else{i[p]=null;l[p]=null;b.actions[p].onfinish(s)}}})};k.pause=function(p){if(typeof p==="undefined"){h(a.ERROR,{eventName:"Sync.pause",message:"'actionName' not passed"});return}if(!o[p]||o[p]===false){o[p]=true;h(a.INFO,{eventName:"Sync.pause",message:"Queue '"+p+"' was told to pause"})}};k.resume=function(p){if(typeof p==="undefined"){h(a.ERROR,{eventName:"Sync.resume",message:"'actionName' not passed"});return}if(!l[p]){if(o[p]===true){o[p]=false;this.start(p);h(a.INFO,{actionName:p,eventName:"Sync.resume",message:"Queue resumed"})}}else{h(a.WARNING,{actionName:p,eventName:"Sync.resume",message:"Cannot resume if last task didn't finish yet"})}}}));