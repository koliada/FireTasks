(function(b,a){var c={};a(c);b.Sync=c}(this,function(l){var f=[],b={},o="koliada.sync",k=["ALL","WARNING","ERROR"],d="WARNING",m={},p={},j=[],a={INFO:"info",WARNING:"warning",ERROR:"error"};l.version="0.1";l.onError=function(q){};function i(q,r){switch(q){case a.INFO:if(["ALL"].indexOf(d)>-1){console.info("Info: ",r)}break;case a.WARNING:if(["ALL","WARNING"].indexOf(d)>-1){console.warn("Warning: ",r)}break;case a.ERROR:if(["ALL","WARNING","ERROR"].indexOf(d)>-1){console.error("Error: ",r)}l.onError(r);break}}function e(q){if(!Array.isArray(q)){q=[q]}return q}function h(r){if(typeof r==="undefined"){var q=localStorage.getItem(o);if(typeof q!=="undefined"){return JSON.parse(q)}else{return null}}localStorage.setItem(o,JSON.stringify(r));return true}function g(){localStorage.removeItem(o)}function n(){var q=h();if(q&&q.length>0){var r=[];f.forEach(function(s){r.push(s.id)});q.forEach(function(s){if(r.indexOf(s.id)===-1){f=e(s).concat(f)}})}}function c(){var q=new Date().getTime();while(q==new Date().getTime()){}return new Date().getTime()}b={actions:{},defaultHandler:function(){i(a.ERROR,{message:"'defaultHandler' not set. Use 'sync.action.setDefaultHandler(func)' or attach separate handler for this Action."})},get:function(q){var s=this.actions;if(typeof q==="undefined"){return s}for(var r in s){if(s.hasOwnProperty(r)){if(r===q){(function(t){s[t].remove=function(){delete s[t];return true}}(r));return s[r]}}}return undefined},set:function(q,s){if(q){var r={func:s||this.defaultHandler,start:function(){Sync.start(q);return r},pause:function(){Sync.pause(q);return r},resume:function(){Sync.resume(q);return r},onStart:function(t){r.onstart=t||function(){};return r},onPause:function(t){r.onpause=t||function(){};return r},onFinish:function(t){r.onfinish=t||function(){};return r}};this.actions[q]=r;this.actions[q].onStart().onPause().onFinish();return this.actions[q]}else{return null}}};l.setStorageVariable=function(q){if(typeof q!=="undefined"){o=q.toString();return true}return false};l.setLogLevel=function(q){if(typeof q==="string"){if(k.indexOf(q)>-1){d=q}else{i(a.WARNING,{eventName:"Sync.setLogLevel",message:"'"+q+"' is not a proper logging level. Possible values: ALL|WARNING|ERROR."})}}};l.action=function(q,r){if(typeof q==="undefined"){return b.get()}if(typeof r==="undefined"){return b.get(q)}return b.set(q,r)};l.action.setDefaultHandler=function(q){if(q){b.defaultHandler=q;return true}return false};l.task=function(s){if(typeof s==="undefined"){s=-1}if(typeof s==="string"||typeof s==="number"){if(s===-1){return f}for(var q=0;q<f.length;q++){if(f[q].id===s.toString()){(function(u){f[u].remove=function(){f.slice(u,1);h(f);return true}}(q));return f[q]}}return undefined}var t=e(s);var r=[];t.forEach(function(u){var w=c().toString();if(u.actionName&&u.data){var v={id:w,actionName:u.actionName,data:u.data,start:function(){Sync.start(this.actionName);return this},pause:function(){Sync.pause(this.actionName);return this},resume:function(){Sync.resume(this.actionName);return this}};f.push(v);r.push(v)}else{i(a.ERROR,{eventName:"Sync.task",message:"'actionName' or 'data' not passed"})}});h(f);return r};l.start=function(q){if(j[q]){i(a.INFO,{actionName:q,eventName:"Sync.start",message:"Queue '"+q+"' already running"});return}if(typeof q==="undefined"){i(a.ERROR,{eventName:"Sync.start",message:"'actionName' not passed"});return}if(p[q]&&p[q]===true){i(a.INFO,{actionName:q,eventName:"Sync.start",message:"Next task halted"});m[q]=null;b.actions[q].onpause();return}if(!m[q]){b.actions[q].onstart()}n();for(var s=0;s<f.length;s++){if(f[s].actionName===q){var r=f.splice(s,1)[0];break}}if(typeof r==="undefined"){i(a.WARNING,{eventName:"Sync.start",message:"No tasks to execute",debugData:{actionName:q,queue:f,currentlyRunning:m[q],storage:h()}});b.actions[q].onfinish();return}m[q]=r.id;j[q]=true;b.actions[r.actionName].func(r.data,function(){var t=Array.prototype.slice.call(arguments),u=t[0];j[q]=null;if(u!==true){i(a.ERROR,{eventName:"Sync.start",message:"Task failed",debugData:{task:r,queue:f,currentlyRunning:m[q],storedTasks:h()}});f.unshift(r);l.start(q);return}if(u===true){h(f);if(f.length>0){l.start(q)}else{j[q]=null;m[q]=null;b.actions[q].onfinish(t)}}})};l.clearStarted=function(){j=[]};l.pause=function(q){if(typeof q==="undefined"){i(a.ERROR,{eventName:"Sync.pause",message:"'actionName' not passed"});return}if(!p[q]||p[q]===false){p[q]=true;i(a.INFO,{eventName:"Sync.pause",message:"Queue '"+q+"' was told to pause"})}};l.resume=function(q){if(typeof q==="undefined"){i(a.ERROR,{eventName:"Sync.resume",message:"'actionName' not passed"});return}if(!m[q]){if(p[q]===true){p[q]=false;this.start(q);i(a.INFO,{actionName:q,eventName:"Sync.resume",message:"Queue resumed"})}}else{i(a.WARNING,{actionName:q,eventName:"Sync.resume",message:"Cannot resume if last task didn't finish yet"})}};l.clearStorage=g;l.getStoredTasks=function(){return h()}}));